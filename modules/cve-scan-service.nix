{ config, pkgs, ... }:

let
  cveScan = pkgs.callPackage ./scan-cves.nix {};
in {
  systemd.services.cveScan = {
    description = "Escaneo semanal de vulnerabilidades CVE en paquetes NixOS";
    wants = [ "network-online.target" ];
    after = [ "network-online.target" ];
    serviceConfig = {
      ExecStart = "${cveScan}/bin/cve-scan";
      User = "root";
      # Para evitar problemas de permisos si usas sandbox o chroot, puedes ajustar aqu√≠
    };
    restart = "on-failure";
  };

  systemd.timers.cveScanTimer = {
    description = "Timer para escanear CVEs semanalmente";
    wants = [ "cveScan.service" ];
    timerConfig = {
      OnCalendar = "weekly";  # Cambia a "daily" para diario
      Persistent = true;
    };
  };
}
